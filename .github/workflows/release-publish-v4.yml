name: Release & Publish Node.js Package (GPR, Restricted)

on:
  push:
    tags:
      - "v*.*.*"           # Triggers on version tags like v1.2.3
  workflow_dispatch:

jobs:
  release-and-publish:
    runs-on: ubuntu-latest

    permissions:
      contents: write      # Needed for creating GitHub Releases
      packages: write      # Needed to publish to GPR

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://npm.pkg.github.com/'
          scope: '@${{ github.repository_owner }}'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build --if-present

      - name: Run tests
        run: npm test

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true

      - name: Publish to GitHub Package Registry (restricted)
        if: startsWith(github.ref, 'refs/tags/')
        run: npm publish --access restricted
        env:
          # Prefer an explicit NPM token; fall back to GH_RELEASE_TOKEN then GITHUB_TOKEN
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN || secrets.GH_RELEASE_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Record package version
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          echo "PACKAGE_VERSION=$(node -p \"require('./package.json').version\")" >> $GITHUB_ENV

      - name: Create tarball for smoke test
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          npm pack

      - name: Smoke test — install packed tarball
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          mkdir -p smoke-tar && cd smoke-tar
          npm init -y
          # Install the tarball produced by npm pack in the repository root
          npm install "${{ github.workspace }}/mcp-framework"/*.tgz --no-package-lock --no-audit
          node -e "require('@debian777/mcp-framework'); console.log('tarball install OK')"

      - name: Smoke test — install from GitHub Packages (optional)
        if: startsWith(github.ref, 'refs/tags/')
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN || secrets.GH_RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          if [ -z "$NODE_AUTH_TOKEN" ]; then
            echo "No publish token found (NPM_TOKEN or GH_RELEASE_TOKEN). Skipping registry smoke test."
            exit 0
          fi
          mkdir -p smoke-reg && cd smoke-reg
          npm init -y
          # Configure registry auth for the scoped package
          echo "@debian777:registry=https://npm.pkg.github.com/" > .npmrc
          echo "//npm.pkg.github.com/:_authToken=$NODE_AUTH_TOKEN" >> .npmrc
          # PACKAGE_VERSION is exported earlier into GITHUB_ENV and available as $PACKAGE_VERSION in the shell
          npm install @debian777/mcp-framework@$PACKAGE_VERSION --no-package-lock --no-audit
          node -e "require('@debian777/mcp-framework'); console.log('registry install OK')"
